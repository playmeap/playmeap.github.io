define(["jquery","underscore","backbone","text!templates/audios/audio-list-item.tpl"],function(d,b,e,a){var c=e.View.extend({tagName:"li",className:"audios-list-item",events:{"click .audios-list-item-control-play":"eventClickPlay","click .audios-list-item-control-pause":"eventClickPause","click .audios-list-item-control-plus":"eventClickPlus","click .audios-list-item-control-minus":"eventClickMinus","click .audios-list-item-control-remove":"eventClickRemove","click .audios-list-item-control-remove-cancel":"eventClickRemoveCancel",'change input[name="duration-set"]':"eventSetTime","click .audios-list-item-progress":"eventClickSetTime","click .audios-list-item-title__title":"eventClickTitle"},initialize:function(f){this.parent=f.parent;this.nodes={};this.nodes.controls={};if(!this.model.views){this.model.views={}}if(this.model.get("itemId")){this.model.views.item=document.getElementById(this.model.get("itemId"));this.nodes.item=this.model.views.item}this.model.views.list=this;this.model.bind("change:play",this.changePlay,this);this.model.bind("change:playprogess",this.changePlayProgress,this);this.model.bind("change:loadprogess",this.changeLoadProgress,this);this.model.bind("change:owner",this.render,this);this.model.bind("audio.delete",this.remove,this);this.model.bind("audio.add",this.addcomplete,this);this.model.bind("audio.isset",this.audioIsset,this)},audioIsset:function(){var f=d('<span class="audios-list-item-message-popup">у вас уже есть эта аудиозапись</span>');this.$el.append(f);this.$el.removeClass("preload");setTimeout(function(){f.remove()},4000)},getNodeAudio:function(){var g=document.getElementById("audio-preload-"+this.model.get("aid")+"-"+this.model.get("owner_id"));if(g){return g}var h=this.model.toJSON();var f=document.createElement("audio");f.id="audio-preload-"+h.aid+"-"+h.owner_id;f.setAttribute("src",h.url);f.setAttribute("data-aid",h.aid);f.setAttribute("data-owner_id",h.owner_id);this.app.views.index.nodes.cache.appendChild(f);if(!this.model.views){this.model.views={}}this.model.set({itemId:f.id});g=document.getElementById("audio-preload-"+this.model.get("aid")+"-"+this.model.get("owner_id"));this.model.views.item=g;return g},changePlayProgress:function(){var f=this.model.get("playprogess");this.nodes.$progressPosition.css({left:f+"%"})},changeLoadProgress:function(){var f=this.model.get("loadprogess");this.nodes.$progressValue.css({width:f+"%"})},changePlay:function(){this.app.log("AudioItemView.changePlay: "+this.model.get("play")+", aid:"+this.model.get("aid")+"| owner_id:"+this.model.get("owner_id")+" CID:"+this.model.cid);if(this.model.get("play")){this.nodes.$progress.removeClass("display-none");this.nodes.controls.$play.addClass("display-none");this.nodes.controls.$pause.removeClass("display-none");return this}this.nodes.$progress.addClass("display-none");this.nodes.controls.$play.removeClass("display-none");this.nodes.controls.$pause.addClass("display-none");return this},eventClickSetTime:function(i){var f=i.offsetX==undefined?i.layerX:i.offsetX;if(f==undefined){f=i.pageX||i.x;f=f-i.target.getBoundingClientRect().left}var g=this.nodes.$progress.width();var h=f/g*100;h=parseInt(this.model.get("duration"))/100*h;this.app.playercontroller.rewind(h)},eventSetTime:function(g){var f=g.target.value;this.app.playercontroller.rewind(f)},eventClickPlay:function(){var g=this.model.get("aid");var f=this.model.get("owner_id");this.app.playercontroller.play(g,f)},eventClickPause:function(){this.app.playercontroller.pause()},eventClickPlus:function(){this.$el.addClass("preload");this.model.audioAdd()},eventClickMinus:function(){this.nodes.controls.$remove.addClass("display-none");this.nodes.controls.$removeBlock.removeClass("display-none")},eventClickRemove:function(){this.$el.addClass("preload");this.model.audioDelete()},eventClickRemoveCancel:function(){this.nodes.controls.$remove.removeClass("display-none");this.nodes.controls.$removeBlock.addClass("display-none")},addcomplete:function(){this.$el.removeClass("preload")},eventClickTitle:function(){if(this.app.fn.get("debug")){this.app.log({msg:"ITEM VIEW",data:this.el});this.app.log({msg:"ITEM MODEL",data:{json:this.model.toJSON(),model:this.model}})}},render:function(){var f;var g=this.model.toJSON();this.$el.removeClass("preload");g.plus=false;if(parseInt(g.owner_id)!==parseInt(this.app.attributes.mid)){g.plus=true}if(g.title.length>=50){g.title=g.title.split(",").join(" ").split(".").join(" ")}f=b.template(a)(g);this.el.innerHTML=f;this.el.id="audio-item_"+g.aid;this.nodes.controls.$play=this.$el.find(".audios-list-item-control-play");this.nodes.controls.$pause=this.$el.find(".audios-list-item-control-pause");this.nodes.controls.$remove=this.$el.find(".audios-list-item-control-minus");this.nodes.$progress=this.$el.find(".audios-list-item-progress");this.nodes.$progressPosition=this.$el.find(".audios-list-item-progress-position");this.nodes.$progressValue=this.$el.find(".audios-list-item-progress-value");this.nodes.controls.$removeBlock=this.$el.find(".audios-list-item-controls-second-remove");return this}});return c});