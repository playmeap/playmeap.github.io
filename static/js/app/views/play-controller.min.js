define(["jquery","underscore","backbone","app/models/play-controller","app/views/index/play-controller-player","text!templates/play-controller.tpl"],function(e,d,g,a,c,b){var f=g.View.extend({timers:{},events:{"keyup .player-controller-search__input":"eventKeyupSearch","click .player-controller-control__bullhorn":"eventClickHorn","click .player-controller-control__repeat":"eventClickRepeat","click .player-controller-control__play":"play","click .player-controller-control__pause":"eventClickPause","click .player-controller-control__stop":"stop","click .player-controller-control__backward":"prev","click .player-controller-control__forward":"next"},initialize:function(){this.children={};this.nodes={};this.nodes.controls={};this.model=new a();this.model.view=this;this.app.models.playercontroller=this.model;this.model.bind("change:repeat",this.changeRepeat,this)},eventKeyupSearch:function(i){var h=i.target.value;this.model.set({searchName:h})},eventClickHorn:function(h){e(h.target).toggleClass("active");if(h.target.className.indexOf("active")>=0){this.model.set({setBroadcast:true})}else{this.model.set({setBroadcast:false})}},eventClickRepeat:function(i){var h=this.model.get("repeat");this.repeat(!h);return this},eventClickPause:function(){this.pause()},changeRepeat:function(){var h=this.nodes.controls.$repeat;if(this.model.get("repeat")){h.addClass("active");return this}h.removeClass("active");return this},rewind:function(j){var h=this.model.getAudioModel();var i=h.get("duration");this.nodes.item.currentTime=j;this.app.log("PlayerController rewind:"+j)},next:function(){this.app.log("PlayerController next repeat:"+this.model.get("repeat"));var h=this.model.getAudioModel();this.app.collections.audios.setElement(h);if(this.nodes.item&&this.nodes.item.currentTime){this.nodes.item.currentTime=0}var i=this.app.collections.audios.next().getElement();if(i){this.play(i.cid)}},prev:function(){var h=this.model.getAudioModel();this.app.collections.audios.setElement(h);var i=this.app.collections.audios.prev().getElement();if(i){this.play(i.cid)}},repeat:function(h){if(h){this.model.set({repeat:true});return this}this.model.set({repeat:false})},stop:function(){if(!this.nodes.item){return false}var h=this.model.getAudioModel();h.set({play:false});if(this.nodes.item.currentTime){this.nodes.item.currentTime=0}this.nodes.item.pause();this.nodes.controls.$play.removeClass("display-none");this.nodes.controls.$pause.addClass("display-none")},pause:function(){if(!this.nodes.item){return false}this.nodes.item.pause();this.nodes.controls.$play.removeClass("display-none");this.nodes.controls.$pause.addClass("display-none");var h=this.model.getAudioModel();h.set({play:false})},_makeItemEvents:function(){this.app.log("PlayerController._makeItemEvents");var h=this;var l=this.nodes.item;var j=this.model.getAudioModel();var k=j.toJSON();(function(p,o){setTimeout(function(){if(p.buffered.length===0){p.remove();if(p.getAttribute("data-cid")==h.model.getAudioModel().cid){h.next()}}},3000)})(l,j);if(this.timers.process){clearInterval(this.timers.process)}this.timers.process=setInterval(function(){var p=h.nodes.item.currentTime;var n=h.model.getAudioModel();var o=p/parseInt(n.get("duration"))*100;o=Math.ceil(o);if(o>100){o=100}n.set({playprogess:o})},1000);var i=function(){var o=0;var n=[];for(var q=0;q<l.buffered.length;q++){n.push([l.buffered.start(q),l.buffered.end(q)])}if(n&&n[0]&&n[0][1]){o=n[0][1]/k.duration*100}o=Math.ceil(o);if(o>100){o=100}var r=this.getAttribute("data-cid");var p=h.model.getAudioModel(r);p.set({loadprogess:o})};var m=function(){h.next()};l.addEventListener("ended",m);l.addEventListener("progress",i)},play:function(m){if(m&&m.target){m=false}var i=this;var j;if(m){j=this.model.getAudioModel(m)}else{j=this.model.getAudioModel();m=j.cid}this.app.log("PlayerController play:"+m);j.set({play:true});this.app.collections.audios.setElement(j);var k=document.getElementById("audio-preload-"+m);if(!this.nodes.cache){this.nodes.cache=this.app.views.index.nodes.cache}if((this.nodes.item&&!k)||(this.nodes.item&&k&&k!==this.nodes.item)){this.app.log("PlayerController play:"+m+", previous item.currentTime = 0");this.nodes.item.pause();if(this.nodes.item.currentTime){this.nodes.item.currentTime=0}}this.nodes.controls.$play.addClass("display-none");this.nodes.controls.$pause.removeClass("display-none");if(k){this.nodes.item=k;this.model.set({acid:m});this.nodes.item.play();k.addEventListener("ended",function(){i.next()})}if(!k){k=document.createElement("audio");k.id="audio-preload-"+m;k.setAttribute("src",j.get("url").split("?")[0]);k.setAttribute("data-cid",m);this.nodes.cache.appendChild(k);this.nodes.item=k;this.model.set({acid:m});k.play();this._makeItemEvents()}var h=this.model.previous("acid");if(h&&h!==m){var l=this.model.getAudioModel(h);l.set({play:false})}},render:function(){this.el.innerHTML=b;this.nodes.controls.$play=this.$el.find(".player-controller-control__play");this.nodes.controls.$pause=this.$el.find(".player-controller-control__pause");this.nodes.controls.$backward=this.$el.find(".player-controller-control__backward");this.nodes.controls.$forward=this.$el.find(".player-controller-control__forward");this.nodes.controls.$stop=this.$el.find(".player-controller-control__stop");this.nodes.controls.$repeat=this.$el.find(".player-controller-control__repeat");this.nodes.controls.$broadcast=this.$el.find(".player-controller-control__bullhorn");this.children.player=new c({parent:this,el:this.$el.find(".player-controller-player")});return this}});return f});