define(["jquery","underscore","backbone","app/models/play-controller","app/views/index/play-controller-player","text!templates/play-controller.tpl"],function(e,d,g,a,c,b){var f=g.View.extend({timers:{},events:{"keyup .player-controller-search__input":"eventKeyupSearch","click .player-controller-control__bullhorn":"eventClickHorn","click .player-controller-control__repeat":"eventClickRepeat","click .player-controller-control__play":"play","click .player-controller-control__pause":"eventClickPause","change .player-controller-search__search-type":"eventChangeSearchGlobal","click .player-controller-control__stop":"stop","click .player-controller-control__backward":"prev","click .player-controller-control__forward":"next","click .player-controller-controls-volume-wrap":"eventClickVolume"},initialize:function(){this.children={};this.nodes={};this.nodes.controls={};this.model=new a();this.model.view=this;this.app.models.playercontroller=this.model;this.models={};this.model.bind("change:repeat",this.changeRepeat,this);this.model.bind("change:volume",this.changeVolume,this)},eventKeyupSearch:function(i){var h=i.target.value;this.model.set({searchName:h})},eventClickHorn:function(h){e(h.target).toggleClass("active");if(h.target.className.indexOf("active")>=0){this.model.set({setBroadcast:true})}else{this.model.set({setBroadcast:false})}},eventClickRepeat:function(i){var h=(i.target.className.indexOf("active")>=0);this.repeat(!h);return this},eventClickPause:function(){this.pause()},eventChangeSearchGlobal:function(h){this.model.set({searchGlobal:h.target.checked})},eventClickVolume:function(k){var j=this.nodes.$volumewrap.width();var i;var h=k.offsetX==undefined?k.layerX:k.offsetX;if(h==undefined){h=k.pageX||k.x;h=h-k.target.getBoundingClientRect().left}i=h/j;if(i<0){i=0}if(i>1){i=1}this.model.set({volume:i})},changeRepeat:function(){var h=this.nodes.controls.$repeat;if(this.model.get("repeat")){h.addClass("active");return this}h.removeClass("active");return this},changeVolume:function(){var h=this.model.get("volume");var i=h*100;this.nodes.controls.$volume.css("left",i+"%");this.setvol(h)},setvol:function(h){if(!this.nodes.item){return false}this.nodes.item.volume=h},rewind:function(j){var h=this.model.getAudioModel();var i=h.get("duration");this.nodes.item.currentTime=j;this.app.log("PlayerController rewind:"+j)},next:function(){this.app.log("PlayerController next repeat:"+this.model.get("repeat"));var h=this.model.getAudioModel(this.model.get("aid"),this.model.get("owner_id"));this.app.collections.audios.setElement(h);if(this.nodes.item&&this.nodes.item.currentTime){this.nodes.item.currentTime=0}var i=this.app.collections.audios.next().getElement();if(i){this.play(i.get("aid"),i.get("owner_id"))}},prev:function(){var h=this.model.getAudioModel(this.model.get("aid"),this.model.get("owner_id"));this.app.collections.audios.setElement(h);var i=this.app.collections.audios.prev().getElement();if(i){this.play(i.get("aid"),i.get("owner_id"))}},repeat:function(h){if(h){this.model.set({repeat:true});return this}this.model.set({repeat:false})},stop:function(){if(!this.nodes.item){return false}var h=this.model.getAudioModel();h.set({play:false});if(this.nodes.item.currentTime){this.nodes.item.currentTime=0}this.nodes.item.pause();this.nodes.controls.$play.removeClass("display-none");this.nodes.controls.$pause.addClass("display-none")},pause:function(){if(!this.nodes.item){return false}this.nodes.item.pause();this.nodes.controls.$play.removeClass("display-none");this.nodes.controls.$pause.addClass("display-none");var h=this.model.getAudioModel();h.set({play:false})},_makeItemEvents:function(){this.app.log("PlayerController._makeItemEvents");var h=this;var l=this.nodes.item;var j=this.model.getAudioModel();var k=j.toJSON();if(this.timers.process){clearInterval(this.timers.process)}this.timers.process=setInterval(function(){var p=h.nodes.item.currentTime;var n=h.model.getAudioModel(h.model.get("aid"),h.model.get("owner_id"));var o=p/parseInt(n.get("duration"))*100;o=Math.ceil(o);if(o>100){o=100}n.set({playprogess:o})},1000);var i=function(){var o=0;var n=[];for(var r=0;r<this.buffered.length;r++){n.push([this.buffered.start(r),this.buffered.end(r)])}if(n&&n[0]&&n[0][1]){o=n[0][1]/k.duration*100}o=Math.ceil(o);if(o>100){o=100}var s=this.getAttribute("data-aid");var q=this.getAttribute("data-owner_id");var p=h.model.getAudioModel(s,q);p.set({loadprogess:o});if(this.buffered.length>0&&this.paused&&parseInt(s)==h.model.get("aid")&&parseInt(q)==h.model.get("owner_id")){this.play()}};var m=function(){if(h.model.get("repeat")){h.play(h.model.get("aid"),h.model.get("owner_id"));return this}h.next()};l.addEventListener("ended",m);l.addEventListener("progress",i);(function(r,o,q,p){setTimeout(function(){if(r.buffered.length===0&&o.get("aid")==h.model.get("aid")&&o.get("owner_id")==h.model.get("owner_id")){if(r.currentTime){r.currentTime=0}r.removeEventListener("ended",p);r.removeEventListener("progress",q);r.pause();r.remove();h.nodes.item.remove();h.play(o.get("aid"),o.get("owner_id"))}},8000)})(l,j,i,m)},play:function(m,i){if(m&&m.target){m=false}var h;if(m&&i){h=this.model.getAudioModel(m,i)}else{h=this.model.getAudioModel();m=h.get("aid");i=h.get("owner_id")}this.app.log("PlayerController play aid:"+m+" | owner_id:"+i);h.set({play:true});if(this.models.current){this.models.prev=this.models.current}if(this.models.prev){this.models.prev.set({play:false})}this.models.current=h;this.app.collections.audios.setElement(h);this.nodes.controls.$play.addClass("display-none");this.nodes.controls.$pause.removeClass("display-none");var j=false;var l=document.getElementById("audio-preload-"+h.get("aid")+"-"+h.get("owner_id"));if(!l){j=true}l=h.views.list.getNodeAudio();if(this.nodes.item&&l&&l!==this.nodes.item){this.app.log("PlayerController play:"+m+", previous item.currentTime = 0");this.nodes.item.pause();if(this.nodes.item.currentTime){this.nodes.item.currentTime=0}}this.nodes.item=l;this.nodes.item.volume=this.model.get("volume");this.model.set({aid:parseInt(m),owner_id:parseInt(i)});var o=this.model.previous("aid");var k=this.model.previous("owner_id");if(j){this._makeItemEvents()}else{this.nodes.item.play()}if(o&&o!==m){var n=this.model.getAudioModel(o,k);n.set({play:false});this.app.log("PlayerController previous set play:false, aid:"+o+" | owner_id:"+k)}},render:function(){this.el.innerHTML=b;this.nodes.controls.$play=this.$el.find(".player-controller-control__play");this.nodes.controls.$pause=this.$el.find(".player-controller-control__pause");this.nodes.controls.$backward=this.$el.find(".player-controller-control__backward");this.nodes.controls.$forward=this.$el.find(".player-controller-control__forward");this.nodes.controls.$stop=this.$el.find(".player-controller-control__stop");this.nodes.controls.$repeat=this.$el.find(".player-controller-control__repeat");this.nodes.controls.$broadcast=this.$el.find(".player-controller-control__bullhorn");this.nodes.$volumewrap=this.$el.find(".player-controller-controls-volume");this.nodes.controls.$volume=this.$el.find(".player-controller-controls-volume__value");this.children.player=new c({parent:this,el:this.$el.find(".player-controller-player")});return this}});return f});