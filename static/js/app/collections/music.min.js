define(["jquery","underscore","backbone","app/models/audio-item"],function(b,a,e,d){var c=e.Collection.extend({model:d,url:"audio.get",cache:[],initialize:function(){this.collectionModel=new (e.Model.extend());this.collectionModel.bind("change",this.fetch,this);this.setElement(this.at(0))},saveCacheCollection:function(f,g){if(!this.getCacheCollection(g)){this.cache.push({items:f,data:g});this.app.log("getCacheCollection.saveCacheCollection")}},getCacheCollection:function(h){var f;var g=a.filter(this.cache,function(i){return a.isEqual(i.data,h)},this);g=a.first(g);if(g){f=g.items}if(f){this.app.log("MusicCollection.getCacheCollection items:"+f.length);return f}this.app.log("MusicCollection.getCacheCollection items:false");return f},searchByName:function(g){g=g.split(" ").join("").toLocaleLowerCase();if(!g){return false}var f=a.filter(this.models,function(j){var l=j.get("title");var h=j.get("artist");var k=l+h;var i=k.split(" ").join("").toLocaleLowerCase().indexOf(g);if(i>=0){return true}});return f},mergeItems:function(i,f){var h=this;var j;var k=h.app.models.playercontroller;var g=parseInt(k.get("aid"));if(!f){f=this.models}j=a.map(i,function(m){var n;var l=a.findWhere(f,{aid:m.aid,owner_id:m.owner_id});if(!l){return m}n=b.extend(true,l.toJSON(),m);if(g&&g==n.aid){n.play=true}else{n.play=false}return n},this);this.app.log("getCacheCollection.mergeItems");return j},postLoad:function(h){var g=this;var i=g.app.models.playercontroller;var f=parseInt(i.get("aid"));VK.Api.call(this.url,h,function(k){if(k&&k.response){var j=k.response.slice(1,k.response.length);j=g.mergeItems(j);a.each(j,function(m){var n;var l=g.findWhere({aid:m.aid,owner_id:m.owner_id});if(l){n=l.toJSON();if(n.play){n.play=false}n=b.extend(true,n,m);if(f&&f==n.aid){n.play=true}else{n.play=false}l.set(n)}},g);g.app.log("MusicCollection.postLoad load set items. "+g.length)}})},getUserCollection:function(g,f,i,h){if(!g){g=this.app.attributes.mid}if(!h){h=this}},fetch:function(){var g=this;var f;var k=this.collectionModel.toJSON();var j=this.getCacheCollection(k);var h=this.collectionModel.previousAttributes();if(!a.isEmpty(h)){var i=this.toJSON();this.saveCacheCollection(i,h)}if(j){f=this.mergeItems(j);setTimeout(function(){g.reset(f);g.postLoad(k);g.app.log("MusicCollection.fetch load cache items. "+g.length)},0);return this}VK.Api.call(this.url,k,function(m){if(m&&m.response){var l=m.response.slice(1,m.response.length);l=g.mergeItems(l);g.reset(l);g.setElement(g.at(0))}else{alert(m.error.error_msg);g.reset([])}})},getElement:function(){return this.currentElement},setElement:function(f){this.currentElement=f},next:function(){this.setElement(this.at(this.indexOf(this.getElement())+1));return this},prev:function(){this.setElement(this.at(this.indexOf(this.getElement())-1));return this}});return c});