define(["jquery","underscore","backbone","app/models/audio-item"],function(b,a,e,d){var c=e.Collection.extend({model:d,url:"audio.get",cache:[],initialize:function(){this.collectionModel=new (e.Model.extend());this.collectionModel.bind("change",this.fetch,this);this.setElement(this.at(0))},saveCacheCollection:function(h,j){var f={};f.items=h;f.data=j;if(parseInt(j.owner_id)===parseInt(this.app.attributes.min)){f.owner=true}if(!this.getCacheCollection(j)){this.cache.push(f);this.app.log("getCacheCollection.saveCacheCollection")}else{var i=this.getCacheCollection(j);var g=this.mergeItems(h,i);this.cache=a.map(this.cache,function(k){if(a.isEqual(k.data,j)){f.items=g;return f}return k},this);this.app.log("getCacheCollection.saveCacheCollection [update-merge]")}},getOwnerCollection:function(i){var g;var f=this;g=a.filter(this.cache,function(j){if(parseInt(j.data.owner_id)===parseInt(this.app.attributes.mid)){return true}},this);if(g&&g.length>=1){if(i){return i.call(this,g[0].items)}return g.slice(1)}var h={};h.owner_id=parseInt(this.app.attributes.mid);this.postLoad(h,function(){f.getOwnerCollection(i)});return false},getCacheCollection:function(h){var f;var g=a.filter(this.cache,function(i){return a.isEqual(i.data,h)},this);g=a.first(g);if(g){f=g.items}if(f){this.app.log("MusicCollection.getCacheCollection items:"+f.length);return f}this.app.log("MusicCollection.getCacheCollection items:false");return f},searchByName:function(g){g=g.split(" ").join("").toLocaleLowerCase();if(!g){return false}var f=a.filter(this.models,function(j){var l=j.get("title");var h=j.get("artist");var k=l+h;var i=k.split(" ").join("").toLocaleLowerCase().indexOf(g);if(i>=0){return true}});return f},mergeItems:function(g,f){var h;if(!f){f=this.models}h=a.map(g,function(j){var i=a.findWhere(f,{aid:j.aid,owner_id:j.owner_id});if(!i){return j}if(i.attributes){i=i.toJSON()}if(j.attributes){j=j.toJSON()}return a.extend(i,j)},this);this.app.log("getCacheCollection.mergeItems");return h},postLoad:function(g,h){var f=this;VK.Api.call(this.url,g,function(j){if(j&&j.response){var i=j.response.slice(1,j.response.length);var k=f.app.models.playercontroller;var l=parseInt(k.get("owner_id"));if(l===parseInt(g.owner_id)){a.each(i,function(n){var o=f.findWhere({aid:n.aid,owner_id:n.owner_id});if(o){var m=a.extend(n,o.toJSON());o.set(m)}else{f.unshift(n);f.trigger("unshift")}},this)}else{f.saveCacheCollection(i,g);if(h){h.call(f,i)}}f.app.log("MusicCollection.postLoad load set items. "+f.length)}})},fetch:function(){var g=this;var f;var k=this.collectionModel.toJSON();var j=this.getCacheCollection(k);var h=this.collectionModel.previousAttributes();if(!a.isEmpty(h)){var i=this.toJSON();this.saveCacheCollection(i,h)}if(j){f=this.mergeItems(j);setTimeout(function(){g.reset(f);g.postLoad(k);g.app.log("MusicCollection.fetch load cache items. "+g.length)},0);return this}VK.Api.call(this.url,k,function(m){if(m&&m.response){var l=m.response.slice(1,m.response.length);l=g.mergeItems(l);g.reset(l);g.setElement(g.at(0))}else{alert(m.error.error_msg);g.reset([])}})}});return c});