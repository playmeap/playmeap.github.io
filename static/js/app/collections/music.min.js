define(["jquery","underscore","backbone","app/models/audio-item"],function(b,a,e,d){var c=e.Collection.extend({model:d,url:"audio.get",cache:[],initialize:function(){this.collectionModel=new (e.Model.extend());this.collectionModel.bind("change",this.fetch,this);this.setElement(this.at(0))},saveCacheCollection:function(g,i){if(!this.getCacheCollection(i)){this.cache.push({items:g,data:i});this.app.log("getCacheCollection.saveCacheCollection")}else{var h=this.getCacheCollection(i);var f=this.mergeItems(g,h);this.cache=a.map(this.cache,function(j){if(a.isEqual(j.data,i)){return f}return j},this);this.app.log("getCacheCollection.saveCacheCollection [update-merge]")}},getCacheCollection:function(h){var f;var g=a.filter(this.cache,function(i){return a.isEqual(i.data,h)},this);g=a.first(g);if(g){f=g.items}if(f){this.app.log("MusicCollection.getCacheCollection items:"+f.length);return f}this.app.log("MusicCollection.getCacheCollection items:false");return f},searchByName:function(g){g=g.split(" ").join("").toLocaleLowerCase();if(!g){return false}var f=a.filter(this.models,function(j){var l=j.get("title");var h=j.get("artist");var k=l+h;var i=k.split(" ").join("").toLocaleLowerCase().indexOf(g);if(i>=0){return true}});return f},mergeItems:function(i,f){var h=this;var j;var k=h.app.models.playercontroller;var g=parseInt(k.get("aid"));if(!f){f=this.models}j=a.map(i,function(m){var n;var l=a.findWhere(f,{aid:m.aid,owner_id:m.owner_id});if(!l){return m}if(l&&l.attributes){return a.extend(l.toJSON(),m)}return a.extend(l,m)},this);this.app.log("getCacheCollection.mergeItems");return j},postLoad:function(g){var f=this;VK.Api.call(this.url,g,function(i){if(i&&i.response){var h=i.response.slice(1,i.response.length);var j=f.app.models.playercontroller;var k=parseInt(j.get("owner_id"));if(k===parseInt(g.owner_id)){a.each(h,function(m){var n=f.findWhere({aid:m.aid,owner_id:m.owner_id});if(n){var l=a.extend(m,n.toJSON());n.set(l)}else{f.unshift(m);f.trigger("unshift")}},this)}f.app.log("MusicCollection.postLoad load set items. "+f.length)}})},fetch:function(){var g=this;var f;var k=this.collectionModel.toJSON();var j=this.getCacheCollection(k);var h=this.collectionModel.previousAttributes();if(!a.isEmpty(h)){var i=this.toJSON();this.saveCacheCollection(i,h)}if(j){f=this.mergeItems(j);setTimeout(function(){g.reset(f);g.postLoad(k);g.app.log("MusicCollection.fetch load cache items. "+g.length)},0);return this}VK.Api.call(this.url,k,function(m){if(m&&m.response){var l=m.response.slice(1,m.response.length);l=g.mergeItems(l);g.reset(l);g.setElement(g.at(0))}else{alert(m.error.error_msg);g.reset([])}})},getElement:function(){return this.currentElement},setElement:function(f){this.currentElement=f},next:function(){this.setElement(this.at(this.indexOf(this.getElement())+1));return this},prev:function(){this.setElement(this.at(this.indexOf(this.getElement())-1));return this}});return c});