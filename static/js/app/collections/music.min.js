define(["jquery","underscore","backbone","app/models/audio-item"],function(b,a,e,d){var c=e.Collection.extend({model:d,url:"audio.get",cache:[],initialize:function(){this.collectionModel=new (e.Model.extend());this.collectionModel.bind("change",this.fetch,this);this.setElement(this.at(0))},saveCacheCollection:function(f,g){if(!this.getCacheCollection(g)){this.cache.push({items:f,data:g})}},getCacheCollection:function(h){var f;var g=a.filter(this.cache,function(i){return a.isEqual(i.data,h)},this);g=a.first(g);if(g){f=g.items}return f},searchByName:function(g){g=g.split(" ").join("").toLocaleLowerCase();if(!g){return false}var f=a.filter(this.models,function(j){var l=j.get("title");var h=j.get("artist");var k=l+h;var i=k.split(" ").join("").toLocaleLowerCase().indexOf(g);if(i>=0){return true}});return f},mergeItems:function(h){var g=this;var i;var j=g.app.models.playercontroller;var f=parseInt(j.get("aid"));i=a.map(h,function(l){var m;var k=g.findWhere({aid:l.aid,owner_id:l.owner_id});if(f&&f!==l.aid){l.play=false}if(!k){return l}m=a.extend({},l,k.toJSON());return m},this);return i},postLoad:function(g){var f=this;VK.Api.call(this.url,g,function(i){if(i&&i.response){var h=i.response.slice(1,i.response.length);h=f.mergeItems(h);a.each(h,function(k){var l;var j=f.findWhere({aid:k.aid,owner_id:k.owner_id});if(j){l=j.toJSON();dataNew=b.extend(true,l,k);if(l.play){dataNew.play=true}j.set(l)}},f);f.app.log("MusicCollection.postLoad load set items. "+f.length)}})},fetch:function(){var g=this;var f;var k=this.collectionModel.toJSON();var j=this.getCacheCollection(k);var h=this.collectionModel.previousAttributes();if(!a.isEmpty(h)){var i=this.toJSON();this.saveCacheCollection(i,h)}if(j){f=this.mergeItems(j);setTimeout(function(){g.reset(f);g.postLoad(k);g.app.log("MusicCollection.fetch load cache items. "+g.length)},0);return this}VK.Api.call(this.url,k,function(m){if(m&&m.response){var l=m.response.slice(1,m.response.length);l=g.mergeItems(l);g.reset(l)}else{alert(m.error.error_msg);g.reset([])}})},getElement:function(){return this.currentElement},setElement:function(f){this.currentElement=f},next:function(){this.setElement(this.at(this.indexOf(this.getElement())+1));return this},prev:function(){this.setElement(this.at(this.indexOf(this.getElement())-1));return this}});return c});