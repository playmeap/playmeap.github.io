define(["jquery","underscore","backbone","app/models/audio-item"],function(b,a,e,d){var c=e.Collection.extend({model:d,url:"audio.get",cache:[],initialize:function(){this.collectionModel=new (e.Model.extend());this.collectionModel.bind("change",this.fetch,this);this.setElement(this.at(0))},saveCacheCollection:function(f,g){if(!this.getCacheCollection(g)){this.cache.push({items:f,data:g})}},getCacheCollection:function(h){var f;var g=a.filter(this.cache,function(i){return a.isEqual(i.data,h)},this);g=a.first(g);if(g){f=g.items}return f},searchByName:function(g){g=g.split(" ").join("").toLocaleLowerCase();if(!g){return false}var f=a.filter(this.models,function(j){var l=j.get("title");var h=j.get("artist");var k=l+h;var i=k.split(" ").join("").toLocaleLowerCase().indexOf(g);if(i>=0){return true}});return f},mergeItems:function(g){var f=this;var h;h=a.map(g,function(j){var k;var i=f.findWhere({aid:j.aid,owner_id:j.owner_id});if(!i){return j}k=b.extend(true,{},j,i.toJSON());return k},this);return h},fetch:function(){var g=this;var f;var i=this.collectionModel.toJSON();var h=this.getCacheCollection(i);if(h){f=this.mergeItems(h);setTimeout(function(){g.reset(f)},0);return this}VK.Api.call(this.url,i,function(k){if(k&&k.response){var j=k.response.slice(1,k.response.length);j=g.mergeItems(j);g.reset(j);delete i.callback;delete i.access_token;g.saveCacheCollection(j,i)}else{alert(k.error.error_msg);g.reset([])}})},getElement:function(){return this.currentElement},setElement:function(f){this.currentElement=f},next:function(){this.setElement(this.at(this.indexOf(this.getElement())+1));return this},prev:function(){this.setElement(this.at(this.indexOf(this.getElement())-1));return this}});return c});