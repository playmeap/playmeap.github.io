define(["jquery","underscore","backbone","app/models/audio-item"],function(b,a,e,d){var c=e.Collection.extend({model:d,url:"audio.get",sortPositions:[],initialize:function(){this.collectionModel=new (e.Model.extend());this.collectionModel.bind("change",this.fetch,this);this.bind("reset",this.actionReset,this)},actionReset:function(){var f=this.collectionModel.toJSON();this.cache.save({data:f,items:this.toJSON()})},postLoad:function(i){var f=this;f.app.log("AudiosCollection.postLoad");var g={};var h=function(k,l,j){if(k.length===0){a.each(g,function(p,q){var n=f.indexOf(f.findWhere({aid:parseInt(q)}));var o=p.reverse();a.each(o,function(r){f.add(r,{at:n-1})})});f.app.log("AudiosCollection.postLoad ready");return}if(!j){j=l.pop()}if(l.length==0&&!j){j=f.at(f.length-1).get("aid")}var m=k.pop();if(m.aid===j&&l.length>0){j=l.pop();return h(k,l,j)}if(!g[j]){g[j]=[]}g[j].push(m);return h(k,l,j)};VK.Api.call(this.url,i,function(k){if(k&&k.response){var j=k.response.slice(1,k.response.length);h(j.reverse(),f.sortPositions.slice(0).reverse())}})},fetch:function(){var h=this;var k=this.collectionModel.toJSON();var g=this.cache.get(k);var j=[];var i={};i.owner_id=parseInt(k.owner_id);if(k.album_id){i.album=k.album_id.toString()}if(this.length>0){var f=this.collectionModel.previousAttributes();a.each(this.models,function(l){l.set({play:false,playprogress:0})});this.cache.save({data:f,items:this.toJSON()})}if(!g){VK.Api.call(this.url,k,function(m){if(m&&m.response){var l=m.response.slice(1,m.response.length);j=a.where(l,i);h.sortPositions=a.pluck(j,"aid");h.reset(j);h.setElement(h.at(0))}else{alert(m.error.error_msg);h.reset([])}})}if(g){setTimeout(function(){j=a.where(g,i);h.reset(j);h.app.log("AudiosCollection.fetch load cache: "+j.length);h.sortPositions=a.pluck(j,"aid");h.setElement(h.at(0));h.postLoad(k)},0)}}});return c});