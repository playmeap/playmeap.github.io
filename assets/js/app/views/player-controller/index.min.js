define(["jquery","underscore","backbone"],function(b,a,d){var c=d.View.extend({optoions:{audio_restart:0},timers:{},play_data:{},initialize:function(){var e=document.createElement("div");e.id="audioList";this.el.appendChild(e);this.audioListNode=e},_playModel:function(f){var e=this;var l=false;var k=f.toJSON();var i=this.audioListNode.childNodes.length;var h=this.audioListNode.querySelector("#audio_item_"+k.aid);a.each(this.audioListNode.childNodes,function(o,m){if(i>e.app.attributes.cacheAudio){var n=i-e.app.attributes.cacheAudio;if(m<n&&o.id!=="audio_item_"+k.aid){o.remove()}}});if(!h){l=true;var g=document.createElement("audio");var j=document.createElement("source");j.src=k.url.split("?")[0];g.appendChild(j);g.id="audio_item_"+k.aid;h=this.audioListNode.appendChild(g)}if(h){if(!this.play_data.model&&h.currentTime){}if(h&&!this.play_data.node||h&&!this.play_data.node.currentTime){b(".audio_"+k.aid+" .progress-position").css({left:"0"})}if(this.play_data&&this.play_data.node){this.play_data.node.pause();if(this.play_data.node.currentTime){}this.play_data={}}this.play_data.played=false;this.play_data.model=f;this.play_data.data=k;this.play_data.node=h;this.play_data.collection=f.collection;this._startPlay();this._makeEvents(l)}},_makeEvents:function(g){var e=this;if(this.timers.process){clearInterval(this.timers.process)}if(this.timers.loaded){clearTimeout(this.timers.loaded)}this.timers.loaded=setTimeout(function(){if(e.play_data.node.buffered.length===0){b(".audio_"+e.play_data.data.aid).addClass("error");e.forward()}},3000);this.timers.process=setInterval(function(){var j=e.play_data.node.currentTime;var i=j/e.play_data.data.duration*100;i=Math.ceil(i);if(i>100){i=100}b(".audio_"+e.play_data.data.aid+" .progress-position").css({left:i+"%"})},1000);var f=function(){var k=0;var j=[];for(var l=0;l<e.play_data.node.buffered.length;l++){j.push([e.play_data.node.buffered.start(l),e.play_data.node.buffered.end(l)])}if(j&&j[0]&&j[0][1]){k=j[0][1]/e.play_data.data.duration*100}if(k>100){k=100}b(".audio_"+e.play_data.data.aid+" .progress-value").css({width:k+"%"})};var h=function(){e.forward()};if(this.play_data&&this.play_data.node&&!g){this.play_data.node.removeEventListener("progress",f);this.play_data.node.removeEventListener("ended",h)}if(g){this.play_data.node.addEventListener("progress",f);this.play_data.node.addEventListener("ended",h)}},rewind:function(f){if(this.play_data.data){var g=this.play_data.data.duration;var e=Math.ceil(g/100*f);this.play_data.node.currentTime=e;b(".audio_"+this.play_data.data.aid+" .progress-position").css({left:f+"%"})}},_startPlay:function(){var f=this.play_data.model.toJSON();var e=b(".audio_item").not(".audio_"+f.aid);var g=b(".audio_"+f.aid);this.app.models.index.set({active_composition:f.aid});this.play_data.model.collection.setElement(this.play_data.model);e.removeClass("active");g.addClass("active");g.trigger("play");e.trigger("stop");this.play_data.node.play()},play:function(f){var e;if(parseInt(f)){if(this.play_data.model&&this.play_data.model.collection){e=this.play_data.model.collection.findWhere({aid:f})}if(!e){e=this.app.collections.audioList.findWhere({aid:f});if(!e){e=this.app.collections.audioFavorites.findWhere({aid:f})}}}if(f&&f.attributes){e=f}if(e){this._playModel(e)}},stop:function(){if(this.play_data&&this.play_data.node){this.play_data.node.pause();this.play_data.node.currentTime=0;var e=b(".audio_"+this.play_data.data.aid);e.trigger("stop")}},pause:function(){if(this.play_data&&this.play_data.node){this.play_data.node.pause();var e=b(".audio_"+this.play_data.data.aid);e.trigger("pause")}},forward:function(){var e=this.play_data.model.collection.next().getElement();this.play(e)},backward:function(){var e=this.play_data.model.collection.prev().getElement();this.play(e)}});return c});