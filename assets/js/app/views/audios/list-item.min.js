define(["jquery","underscore","backbone","text!templates/audios/list-item.html"],function(d,b,e,a){var c=e.View.extend({tagName:"li",className:"col-sm-12 audioListItem disable",events:{"click .favorite-add":"addToFavorite","click .favorite-remove":"removeFromFavorite","click .play":"playItem","click .pause":"pauseItem","click .stop":"stopItem","click .progress":"rewind","click .download":"downloadItem"},initialize:function(){this.play=function(){var f=this.app.collections.audioFavorites.findWhere({aid:this.model.get("aid")});var g=this.el.querySelector(".favorite-add");if(f&&g){g.className="glyphicon glyphicon-remove-sign favorite-remove";g.setAttribute("title","Удалить из избранного")}this.el.classList.add("active");this.el.querySelector(".playcontrol").classList.add("glyphicon-pause","pause");this.el.querySelector(".playcontrol").classList.remove("glyphicon-play","play");this.el.querySelector(".stop").classList.remove("hidden")}.bind(this);this.stop=function(){this.el.classList.remove("active");this.el.querySelector(".playcontrol").classList.remove("glyphicon-pause","pause");this.el.querySelector(".playcontrol").classList.add("glyphicon-play","play");this.el.querySelector(".stop").classList.add("hidden")}.bind(this);this.pause=function(){this.el.querySelector(".playcontrol").classList.remove("glyphicon-pause","pause");this.el.querySelector(".playcontrol").classList.add("glyphicon-play","play");this.el.querySelector(".stop").classList.remove("hidden")}.bind(this);this.$el.on("play",this.play);this.$el.on("stop",this.stop);this.$el.on("pause",this.pause)},downloadItem:function(){},playItem:function(){this.app.views.playerController.play(this.model.get("aid"))},stopItem:function(){this.app.views.playerController.stop()},pauseItem:function(){this.app.views.playerController.pause()},rewind:function(i){var f=i.offsetX==undefined?i.layerX:i.offsetX;if(f==undefined){f=i.pageX||i.x;f=f-i.target.getBoundingClientRect().left}var g=this.$nodeProgress.width();var h=f/g*100;this.app.views.playerController.rewind(h)},addToFavorite:function(k){var g=this;var j={};j.album_id=this.app.models.index.get("play_album");j.audio_ids=[this.model.get("aid")];var f={};f.owner_id=this.app.attributes.mid;var i=g.el.querySelector(".favorite-add");var h=this.app.collections.audioFavorites.findWhere({aid:this.model.get("aid")});if(h){i.className="glyphicon glyphicon-remove-sign favorite-remove";i.setAttribute("title","Удалить из избранного");k.preventDefault();return false}i.className="glyphicon glyphicon-remove-sign favorite-remove";i.setAttribute("title","Удалить из избранного");if(this.model.get("owner_id")!==this.app.attributes.mid){VK.Api.call("audio.get",f,function(l){if(l&&l.response){var m=b.where(l.response,{artist:g.model.get("artist"),duration:g.model.get("duration"),title:g.model.get("title")});if(m.length>=1){b.each(m,function(o){VK.Api.call("audio.delete",{audio_id:o.aid,owner_id:g.app.attributes.mid},function(p){})})}var n={owner_id:g.model.get("owner_id"),audio_id:g.model.get("aid")};VK.Api.call("audio.add",n,function(o){if(o&&o.response){j.audio_ids=[o.response];VK.Api.call("audio.moveToAlbum",j,function(p){if(p&&p.response){g.app.collections.audioFavorites.add(g.model)}})}})}})}else{VK.Api.call("audio.moveToAlbum",j,function(l){if(l&&l.response){g.app.collections.audioFavorites.add(g.model)}})}},removeFromFavorite:function(){var f=this;var h={};h.mid=this.app.attributes.mid;h.album_id=0;h.audio_ids=[this.model.get("aid")];var g=f.app.collections.audioFavorites.findWhere({aid:this.model.get("aid")});if(g){VK.Api.call("audio.moveToAlbum",h,function(j){if(j&&j.response){g.collection.remove(g);var i=f.el.querySelector(".favorite-remove");if(i){i.className="glyphicon glyphicon-ok-sign favorite-add";i.setAttribute("title","Добавить в избранное")}}})}},render:function(){var g=this.model.toJSON();g.favorite=false;if(this.app.collections.audioFavorites.where({aid:g.aid}).length>=1){g.favorite=true}this.el.innerHTML=b.template(a)(g);this.$el.addClass("audio_item audio_"+g.aid);this.nodeProgress=this.el.querySelector(".progress");this.$nodeProgress=d(this.nodeProgress);var f=this.app.models.index.get("active_composition");if(f&&f===g.aid){this.play()}return this}});return c});